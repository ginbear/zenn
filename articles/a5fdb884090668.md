---
title: "ã€EKSã€‘Amazon Linux 2 ã‹ã‚‰ Amazon Linux 2023 ã¸ã®ç§»è¡Œï¼ˆnodeadm / IMDSv2ï¼‰"
emoji: "ğŸ”–"
type: "tech"
topics:
  - "kubernetes"
  - "eks"
  - "datadog"
  - "irsa"
  - "imds"
published: true
published_at: "2025-12-15 09:23"
---

ã“ã®è¨˜äº‹ã¯ã€kubernetes Advent Calendar 2025 ã® 15 æ—¥ç›®ã§ã™ã€‚
https://qiita.com/advent-calendar/2025/kubernetes

## ã¯ã˜ã‚ã«

æœ¬è¨˜äº‹ã¯ã€æœ€è¿‘ EKS ä¸Šã§ EOL ã‚’è¿ãˆãŸ Amazon Linux 2ï¼ˆä»¥ä¸‹ã€AL2ï¼‰ã‹ã‚‰ã€Amazon Linux 2023ï¼ˆä»¥ä¸‹ã€AL2023ï¼‰ã¸ç§»è¡Œã—ãŸéš›ã®å¯¾å¿œã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

EKS ä¸Šã« AL2 ãŒç¨¼åƒã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ãªã£ã¦ãŠã‚Šã€EKS ã§ã® AL2 ã¯ 2025/11/26 ã« EOL ã‚’è¿ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã¾ãŸã€K8s 1.33 ä»¥é™ã® Amazon Linux 2 AMI ã‚’ãƒªãƒªãƒ¼ã‚¹ã—ãªã„ã¨ã‚‚æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚
> Checks if any nodes in the cluster are running Amazon Linux 2. Support for Amazon Linux 2 on Amazon EKS will end on November 26, 2025. Additionally, Amazon EKS will not release Amazon Linux 2 AMIs for Kubernetes version 1.33 and higher
![](https://storage.googleapis.com/zenn-user-upload/173f38d19d01-20251211.png)

ã¡ãªã¿ã«ã€AL2 è‡ªä½“ã® EOL ã¯ 2026/6/30 ã§ã¾ã å°‘ã—ä½™è£•ãŒã‚ã‚Šã¾ã™ã€‚
ref. https://aws.amazon.com/jp/amazon-linux-2/faqs/

ä¸Šè¨˜ã®é€šã‚Šã€Amazon EKS ã§ã® AL2 ã®ã‚µãƒãƒ¼ãƒˆã¯ã™ã§ã«çµ‚äº†ï¼ˆæ­£ç¢ºã«ã¯EKS Optimized AL2 AMI ã®æ›´æ–°ãƒ»æä¾›çµ‚äº†ã§å‹•ä½œã¯ã¾ã ã™ã‚‹ã¯ãšï¼‰ã—ã¦ã„ã‚‹ã‚ã‘ã§ã™ãŒã€å¯¾å¿œã‚’é€²ã‚ã¦ã„ã‚‹ç’°å¢ƒãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ä½•ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

åŸºæœ¬çš„ãªæ–¹é‡ã¯ã€å…¬å¼ãŒã¾ã¨ã‚ã¦ã„ã‚‹å†…å®¹ã‚’ä¸€ã¤ãšã¤æ½°ã—ã¦ã„ãä½œæ¥­ã¨ãªã‚Šã¾ã™ã€‚

https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/al2023.html

ã“ã“ã§ã¯ã€ä»¥ä¸‹2ç‚¹ã«çµã£ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

1. èµ·å‹•ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ§‹æˆï¼ˆnodeadm ã¸ã®å¤‰æ›´ï¼‰
2. IMDSv2 ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåŒ–åŠã³ Hop Limit åˆ¶é™ã¸ã®å¯¾å¿œ

## 1. nodeadm ã¸ã®å¤‰æ›´ï¼ˆTerraform å®Ÿè£…ï¼‰

Self-Managed ãª Node Group ãŒã‚ã‚‹ãªã©ã€User Data ã‚’è‡ªåˆ†ãŸã¡ã§ç®¡ç†ã—ã¦ã„ã‚‹ç’°å¢ƒã§ã¯ã€AL2023 å‘ã‘ã®è¨­å®šã«å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã‚ãªã„ã¨ã€ãƒãƒ¼ãƒ‰ãŒ EKS ã‚¯ãƒ©ã‚¹ã‚¿ã«æ­£å¸¸ã«å‚åŠ ã—ãªã„ã¨ã„ã†äº‹è±¡ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

AL2023 ã§ã¯ã€ãƒãƒ¼ãƒ‰ã®åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ãŒå¤‰æ›´ã•ã‚Œã€å¾“æ¥ã® User Data ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ/etc/eks/bootstrap.sh ã‚’å©ãæ–¹å¼ï¼‰ã§ã¯ãªãã€nodeadm ã‚’ä½¿ç”¨ã™ã‚‹æ§‹æˆãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

Terraform ã® aws_launch_template ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ã£ã¦ç®¡ç†ã—ã¦ã„ã‚‹å ´åˆã€User Data ã®æ›¸ãæ–¹ã‚’å¤§ããå¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚MIME ãƒãƒ«ãƒãƒ‘ãƒ¼ãƒˆå½¢å¼ã§è¨­å®šã‚’æ¸¡ã™ã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

config ã‚’ä½œã‚‹ã«ã‚ãŸã‚Šå‚è€ƒã«ã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã“ã¡ã‚‰ã§ã™ã€‚
https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/launch-templates.html
https://awslabs.github.io/amazon-eks-ami/nodeadm/

### AL2023 nodeadm ç”¨ Terraform è¨­å®šã‚µãƒ³ãƒ—ãƒ«

1. nodeadm NodeConfig ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (nodeadm.yaml.tpl)

```
  ---
  apiVersion: node.eks.aws/v1alpha1
  kind: NodeConfig
  spec:
    cluster:
      name: ${cluster_name}
      apiServerEndpoint: ${cluster_endpoint}
      certificateAuthority: ${cluster_ca}
      cidr: ${service_cidr}
    kubelet:
      config:
        clusterDNS:
        - ${cluster_dns}
      # â€» label/taint ãŒå¿…è¦ãªå ´åˆã®ã¿è¿½åŠ :
        # registerWithTaints:
        # - key: dedicated
        #   value: batch
        #   effect: NoSchedule
      # flags:
      # - --node-labels=workload=batch
```

  2. user_data ç”Ÿæˆ (locals.tf)

```
  locals {
    boundary = "BOUNDARY"

    # base64encode ã—ã¦æ¸¡ã™å¿…è¦ãŒã‚ã‚‹
    user_data = base64encode(<<-EOF
  MIME-Version: 1.0
  Content-Type: multipart/mixed; boundary="${local.boundary}"

  --${local.boundary}
  Content-Type: application/node.eks.aws

  ${templatefile("${path.module}/nodeadm.yaml.tpl", {
    cluster_name     = aws_eks_cluster.this.name
    cluster_endpoint = aws_eks_cluster.this.endpoint
    cluster_ca       = aws_eks_cluster.this.certificate_authority[0].data
    service_cidr     = aws_eks_cluster.this.kubernetes_network_config[0].service_ipv4_cidr
    cluster_dns      = cidrhost(aws_eks_cluster.this.kubernetes_network_config[0].service_ipv4_cidr, 10)
  })}

  --${local.boundary}--
  EOF
    )
  }
```

  3. Launch Template (launch_template.tf)

```
  resource "aws_launch_template" "eks_node" {
    name     = "eks-node-al2023"
    image_id = data.aws_ssm_parameter.eks_ami.value  # AL2023 EKS Optimized AMI

    # <-- snip: instance_type, block_device_mappings, iam_instance_profile, etc. -->

    # ã“ã“ãŒ AL2023 nodeadm ã®ãƒã‚¤ãƒ³ãƒˆ
    user_data = local.user_data
  }
```

| é …ç›®         | AL2 (bootstrap.sh) | AL2023 (nodeadm)         |
|--------------|--------------------|--------------------------|
| è¨­å®šå½¢å¼     | ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ   | YAML (NodeConfig)        |
| Content-Type | text/x-shellscript | application/node.eks.aws |

å®Ÿéš›ã«æŒ‡å®šã—ãŸèµ·å‹•ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ¸¡ã£ã¦ã„ã‚‹ã®ã‹ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã—ã¾ã—ãŸã€‚
Terraform ã§é©ç”¨ã•ã‚ŒãŸçµæœã‚’ç¢ºèªã™ã‚‹ã«ã‚ãŸã‚Šå¤§å¤‰ä¾¿åˆ©ã§ã—ãŸã€‚

```bash
aws ec2 describe-launch-template-versions \
  --launch-template-id <lt-xxxxx> \
  --versions '$Latest' \
  --query 'LaunchTemplateVersions[0].LaunchTemplateData.UserData' \
  --output text | base64 -d
```

## 2. IMDSv2 ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåŒ–åŠã³ Hop Limit åˆ¶é™ã¸ã®å¯¾å¿œ

### å•é¡Œã®ç™ºç”Ÿ

ä»Šå›åˆ©ç”¨ã—ã¦ã„ã‚‹ EKS Managed Node Group ã§ã¯ã€AL2023 ãƒ™ãƒ¼ã‚¹ã®ãƒãƒ¼ãƒ‰ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ IMDSv2 (Instance Metadata Service Version 2) ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ãŠã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®ãŸã‚ã« Hop Limitï¼ˆHTTP è»¢é€å›æ•°ã®åˆ¶é™ï¼‰ãŒ 1 ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã—ãŸ[^1]ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒãƒƒãƒ‰å†…ã‹ã‚‰ãƒãƒ¼ãƒ‰ã® IAM ãƒ­ãƒ¼ãƒ«ï¼ˆInstance Profileï¼‰ã®æ¨©é™ã‚’ä½¿ã£ã¦ AWS ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ãŸå‡¦ç†ãŒã€Hop Limit åˆ¶é™ã«å¼•ã£ã‹ã‹ã‚Šé€šä¿¡ã§ããªããªã‚‹äº‹è±¡ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     EC2 Instance (Host)      â”‚
â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   Pod A    â”‚â”€ âœ“ OK!       â”‚ â† ãƒ›ã‚¹ãƒˆã¨åŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   (hop=0)    â”‚
â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Pod B (Container)  â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚
â”‚  â”‚  â”‚ Application  â”‚â”€ âœ— NG!  â”‚ â† ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ï¼ˆhop=1 ä»¥ä¸Šï¼‰
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â†“ (hop count = 2)    â”‚
â”‚    169.254.169.254           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ã¤ã¾ã‚Šã€ŒIMDSv2 ã«ã‚ˆã‚‹å½±éŸ¿èª¿æŸ»ã€ã¨ã€ŒHop Limit åˆ¶é™ã®å¯¾å¿œã€ã®äºŒã¤ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### å¯¾å¿œæ–¹é‡ï¼šHop Limit ç·©å’Œã§ã¯ãªãã€IRSA ã‚’å¾¹åº•ã™ã‚‹

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç­‰ã§ã¯ã€ŒHop Limit ã‚’ 2 ã«ä¸Šã’ã‚‹ã€ã¨ã„ã†ç·©å’Œç­–ã‚‚ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ãŒã€AWS ã§ã¯ IRSA ã‚’æ¨å¥¨ã—ã¦ãŠã‚Šã€ä»Šå›ã® HopLimit å•é¡Œã‚’æ©Ÿã«ã€ŒPod ã«å¿…è¦ãªæ¨©é™ã¯ã™ã¹ã¦ IRSA ã«é›†ç´„ã™ã‚‹ã€ã¨ã„ã†æ§‹æˆã«ç§»è¡Œã—ã¾ã—ãŸã€‚

- Node IAM Role: å¿…è¦æœ€å°é™ï¼ˆCNIç”¨ãªã©ï¼‰ã®æ¨©é™ã®ã¿ã«ã™ã‚‹ã€‚
- Pod: å¿…è¦ãªæ¨©é™ã¯ã™ã¹ã¦ ServiceAccount ã«ç´ã¥ã„ãŸ IAM Role ã‹ã‚‰å–å¾—ã™ã‚‹ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒãƒ¼ãƒ‰è‡ªä½“ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’ä½æ¸›ã•ã›ã€ã‚ˆã‚Šæœ¬æ¥ã‚ã‚‹ã¹ãæ¨©é™ç®¡ç†ã®çŠ¶æ…‹ã«æŒã£ã¦ã„ãã“ã¨ãŒã§ãã¾ã—ãŸã€‚

### ã©ã†èª¿æŸ»ã™ã‚‹ã‹ã®æ¤œè¨

å†’é ­ã® AWS ã«ã‚ˆã‚‹ç§»è¨­ã‚¬ã‚¤ãƒ‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªãƒ³ã‚¯ã«ã‚‚ã‚ã£ãŸã®ã§ã™ãŒã€IMDSv2 ã¸ã®ç§»è¡Œã‚¬ã‚¤ãƒ‰ã‚‚ AWS ã‹ã‚‰æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚AWS ã•ã‚“ãªã‚“ã§ã‚‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒãŸã„ã€‚

https://aws.amazon.com/jp/blogs/security/get-the-full-benefits-of-imdsv2-and-disable-imdsv1-across-your-aws-infrastructure/

ã“ã“ã§ã¯ Amazon CloudWatch ã® MetadataNoToken ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¢ºèªã™ã‚‹æ–¹æ³•ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€IMDSv1 ã®é€šä¿¡å‚¾å‘ã¯ã‚ã‹ã‚‹ã‚‚ã®ã®ã€å®Ÿéš›ä½•ãŒé€šä¿¡ã—ã¦ã„ã‚‹ã®ã‹ã€ãã—ã¦ IMDSv2 ã ã£ãŸã¨ã—ã¦ã‚‚ Hop limit ã«ã‚ˆã‚Šå½±éŸ¿ã‚’å—ã‘ã‚‹ã®ã‹ã¯ã“ã“ã‹ã‚‰èª­ã¿å–ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚

ãã“ã§ã€ã„ãã¤ã‹æ–¹æ³•ã‚’è€ƒãˆè©¦ã—ã¾ã—ãŸã€‚

- Datadog Cloud Network Monitoring (æœ€è¿‘ NPM ã‹ã‚‰åå‰ãŒå¤‰ã‚ã£ãŸ Datdog ã® ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¯è¦–åŒ–ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ 
    - ä½¿ç”¨æ„Ÿã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚å…¼ã­ã¦ä½¿ã£ã¦ã¿ãŸ
    - Local network ã®è¨­å®šã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã—ã¾ã„ã€ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ãŒçµ‚ã‚ã£ã¦ã—ã¾ã£ãŸ
- VPC Flow Logs ã‚’å–å¾—ã—ã¦ 169.254.169.254 å®›ã®é€šä¿¡ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
    - æ®‹å¿µãªãŒã‚‰[Flow logs ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¯ã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚Œãªã„ä»•æ§˜ã ã£ãŸ](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/flow-logs-limitations.html)
- ãã—ã¦ãŸã©ã‚Šç€ã„ãŸ aws-imds-packet-analyzer

### ãƒ­ã‚°ã«ã‚ˆã‚‹å½±éŸ¿èª¿æŸ»ï¼ˆaws-imds-packet-analyzerï¼‰

ã“ã‚Œã§ã™ã€‚ä½œã£ãŸäººã«æ„Ÿè¬ã‚’è´ˆã‚ŠãŸã„ğŸ«¶

https://github.com/aws/aws-imds-packet-analyzer

ã“ã® aws-imds-packet-analyzer ã‚’ DaemonSet ã¨ã—ã¦å¯¾è±¡ã®ã‚¯ãƒ©ã‚¹ã‚¿ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€IMDS ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’åé›†ã—ã¾ã—ãŸã€‚
ã“ã‚Œã‚’ OSS ã¨ã—ã¦ã‚‚ç”¨æ„ã—ã¾ã—ãŸã€‚eBPF ã‚’ä½¿ã†ãŸã‚ `privileged: true`ã€`hostNetwork`ã€`hostPID` ãŒå¿…è¦ã§ã™ã€‚ä¸€æ™‚çš„ãªèª¿æŸ»ç”¨ã¨ã™ã‚‹ãªã©ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¯ãŠæ°—ã‚’ã¤ã‘ãã ã•ã„ã€‚

https://github.com/ginbear/aws-imds-packet-analyzer-k8s/

### ãƒ­ã‚°ã‚µãƒ³ãƒ—ãƒ«

ä¾‹ãˆã°ã“ã‚“ãªæ„Ÿã˜ã®ãƒ­ã‚°ãŒå–å¾—ã§ãã¾ã™(ãƒã‚¹ã‚­ãƒ³ã‚°æ¸ˆã¿)ã€‚

```
[INFO] imdsv2 (pid:12345:argoexec argv:argoexec wait --loglevel info) called by -> (pid:12340:containerd-shim argv:/usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id abc123def456...) -> (pid:1:systemd argv:/usr/lib/systemd/systemd --switched-root --system --deserialize 21) req details: get /latest/meta-data/iam/security-credentials/my-eks-node-role http/1.1, host: 169.254.169.254, user-agent: aws-sdk-go/1.xx.xx (go1.xx.xx; linux; amd64), **token redacted**, accept-encoding: gzip,
```

åˆ†è§£ã—ã¦ã„ãã¨ã“ã®ã‚ˆã†ãªã‚¢ã‚¯ã‚»ã‚¹ãŒè¦‹ãˆã¦ãã¾ã™ã€‚

```
  systemd                   â†  Node ã® init
    â””â”€â”€ containerd-shim     â†  Pod ã®ã‚³ãƒ³ãƒ†ãƒŠç®¡ç†
          â””â”€â”€ argoexec      â†  â˜… IMDS ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå¼µæœ¬äºº
                 â”‚
                 â”‚ GET /latest/meta-data/iam/security-credentials/<role-name>
                 â–¼
           169.254.169.254 (IMDS)
```

ã“ã®ãƒ­ã‚°ã‚’ä¸€å®šæœŸé–“å‡ºåŠ›ã—ã¦ã€IMDSã‚’çµŒç”±ã™ã‚‹é€šä¿¡ã‚’ç²¾æŸ»ã—ã¾ã—ãŸã€‚
IMDSv1ã®é€šä¿¡ã¯ãƒ­ã‚°ã‹ã‚‰ã™ãã«åˆ¤åˆ¥ã§ãã¾ã™ãŒã€Hop limit ã«é–¢ä¿‚ã™ã‚‹ã‹ã¯ã©ã®ã‚ˆã†ãªé€šä¿¡ã§ã‚ã‚‹ã‹ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®æ™‚ç™ºè¦‹ã—ãŸã®ã¯ã€kubectl logs ã§ã¯ãªãç›´æ¥ pod ã‹ã‚‰è»¢é€ã™ã‚‹ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒä»˜ã„ã¦ã¦ä¾¿åˆ©ã§ã—ãŸã€‚ã—ã‹ã—ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ã«ã‚ˆã‚ŠæœŸé–“ãŒçŸ­ããªã£ã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã”æ³¨æ„ä¸‹ã•ã„ã€‚

```shell
for pod in $(kubectl get pods -n default -l app=aws-imds-packet-analyzer -o name); do
  kubectl logs -n default $pod > ${pod##*/}-$(date +%Y%m%d-%H%M%S).log
done
```

â†“ ã“ã£ã¡ã ã¨ timestamp ä»˜ã§ãƒ­ã‚°å–å¾—ã§ãã¾ã™ã€‚ãŸã ã—å–å¾—ã§ãã‚‹ãƒ­ã‚°ã®æœŸé–“ã¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ï¼‰çŸ­ã‚ã§ã™ã€‚ãƒ­ã‚°ãƒ‘ã‚¹ãªã©ã¯ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ãã ã•ã„ã€‚

```shell
for pod in $(kubectl get pods -n default -l app=aws-imds-packet-analyzer -o name); do
    # å…¨ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’çµåˆã—ã¦å–å¾—
    kubectl exec -n default $pod -- sh -c 'cat /var/log/imds/imds-trace.log.* /var/log/imds/imds-trace.log 2>/dev/null | sort' > ${pod##*/}-$(date +%Y%m%d-%H%M%S).log
done
```

ã¾ãŸã€é€”ä¸­ã‹ã‚‰æ°—ä»˜ã„ãŸã®ã§ã™ãŒã€Datadog Agent ã®ãƒ­ã‚°åé›†ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã„ãŸãŸã‚ã€DaemonSet ã¨ã—ã¦å‹•ä½œã—ã¦ã„ã‚‹ aws-imds-packet-analyzer ã®ãƒ­ã‚°ã‚‚ Datadog ã«è»¢é€ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚
ã“ã‚Œã«ã‚ˆã‚Šãƒ­ã‚°ã®èª¿æŸ»ã‚‚ Datadog ã® Logging ã§ç²¾æŸ»ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã¡ã‚‰ãªã‚‰ timestamp ã‚‚ã¤ã„ã¦ã„ã¾ã™ã—ã€æ§˜ã€…ãª tag æƒ…å ±ã‚‚ä»˜ä¸ã•ã‚Œã¦ã„ã¾ã™ã®ã§ã€èª¿æŸ»ã®åŠ©ã‘ã«ãªã‚Šã¾ã™ã€‚

### çµ‚ã‚ã‚Šã«

AL2 ã‹ã‚‰ AL2023 ã«ç§»è¨­ã™ã‚‹æ™‚ã«èª¿æŸ»ãƒ»å¯¾å¿œã‚’ã—ãŸå†…å®¹ã®ä¸€éƒ¨ã‚’ã”ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ç§»è¨­ã¯å®Œäº†ã—ã¦ãŠã‚Šã€ä½•ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚‚ãªãç„¡äº‹ã«...! ã¨è¨€ã„ãŸã„ã¨ã“ã‚ã§ã™ãŒã€å®Ÿéš›ã«ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã§ç¨¼åƒã™ã‚‹ã¨ã€ç‰¹å®šã® Pod ãŒã¾ã  IMDS ã«ä¾å­˜ã—ã¦ã„ãŸç®‡æ‰€ãŒã‚ã‚Šã€ãã“ã¯å¾Œè¿½ã„ã§ IRSA åŒ–ã‚’è¡Œã„ã¾ã—ãŸã€‚å®Œç’§ãªå¯¾å¿œã¯é›£ã—ã„ï¼

[^1]: ã“ã®è¨˜äº‹ã‚’æ›¸ããªãŒã‚‰èª¿æŸ»ã—ãŸã¨ã“ã‚ã€https://docs.aws.amazon.com/ja_jp/linux/al2023/ug/imdsv2.html ã‚’èª­ã‚€ã¨ AL2023 ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ›ãƒƒãƒ—åˆ¶é™ã¯ 2 ã¨ãªã£ã¦ã„ã¾ã—ãŸã€‚æã‚‰ãEKS Managed Node Group ã§ AL2023 AMI ã‚’ä½¿ã£ãŸã¨ãã«ã€ãƒ›ãƒƒãƒ—åˆ¶é™ãŒ 1 ã¨ãªã£ã¦ã„ã‚‹ã“ã¨ãŒæ‰‹å…ƒã®ç’°å¢ƒã§ã¯ç¢ºèªã§ãã¾ã—ãŸã€‚
