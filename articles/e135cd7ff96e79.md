---
title: "Argo CD v2 â†’ v3 ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§å¯¾å¿œãŒå¿…è¦ã ã£ãŸãƒã‚¤ãƒ³ãƒˆ"
emoji: "ğŸ™"
type: "tech"
topics:
  - "kubernetes"
  - "eks"
  - "argocd"
published: true
published_at: "2025-12-17 13:48"
publication_name: "atrae"
---

Argo CD ã‚’ v2.xx ã‹ã‚‰ v3.xx ç³»ã¸ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ãŸã¨ãã®ãŠè©±ã§ã™ã€‚

## ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ¦‚è¦

Argo CD ã¯ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å†…å®¹ã‚’ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚ã‚ã‚ŠãŒãŸã‚„ğŸ™

https://argo-cd.readthedocs.io/en/latest/operator-manual/upgrading/2.14-3.0/

v2.14 to 3.0 ã®å†’é ­ã§ã¯ã€

> Argo CD 3.0 is meant to be a low-risk upgrade containing only minor breaking changes.
> DeepLè¨³: Argo CD 3.0 ã¯ã€è»½å¾®ãªäº’æ›æ€§å¤‰æ›´ã®ã¿ã‚’å«ã‚€ä½ãƒªã‚¹ã‚¯ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¨ãªã‚‹ã“ã¨ã‚’æ„å›³ã—ã¦ã„ã¾ã™ã€‚

ã¨ã‚ã‚‹ã‚ˆã†ã«ã€ä½ãƒªã‚¹ã‚¯ã§ã‚ã‚‹ã“ã¨ã‚’èª¬æ˜ã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚
å®Ÿéš›ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’è¡Œã„ã€å¯¾å¿œãŒå¿…è¦ã¨ã‚ã‹ã£ãŸä¸€éƒ¨ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚
ï¼ˆç’°å¢ƒã”ã¨ã«å¯¾å¿œæ–¹æ³•ãªã©å¤‰ã‚ã£ãŸã‚Šã™ã‚‹ã‹ã¨æ€ã„ã¾ã™ã®ã§äº‹ä¾‹ç´¹ä»‹ã§ã™ã€‚ï¼‰

### repository.credentials ãŒ secret ç®¡ç†ã«

https://argo-cd.readthedocs.io/en/stable/operator-manual/upgrading/2.14-3.0/#removed-support-for-legacy-repo-config-in-argocd-cm

> Removed support for legacy repo config in argocd-cmÂ¶

ã“ã‚Œã§ã™ã€‚ãƒªãƒã‚¸ãƒˆãƒªã®æƒ…å ±ã‚’ argocd-cm ã‹ã‚‰ Secrets ã¸ç§»ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

3.0 ç³»ã§ã¯ argocd-cm ã‚’è¦‹ã¦ãã‚Œãªã„ã®ã§ã€èªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãš SSH agent ã‚’æ¢ã—ã¦ã‚‚è¦‹ã¤ã‹ã‚‰ãš `SSH agent requested but SSH_AUTH_SOCK not-specified` ã¨ã„ã£ãŸã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ã€‚

ã¾ãŸã€In-Cluster + Self-managed æ§‹æˆã§ Argo CD ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã«é™ã‚‹ã¨æ€ã„ã¾ã™ãŒ^[ãƒ­ã‚°ã‚„æŒ™å‹•ã‹ã‚‰ã®æ¨æ¸¬ã§ã™]ã€Argo CD ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚ã’ãŸéš›ã«ã€æ–°ã—ã„ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’å–ã‚Šã«éš›ã«ãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã€secret ã‚’å–å¾—ã§ããšçµå±€åŒã˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸäº‹è±¡ã‚‚ç™ºç”Ÿã—ã¾ã—ãŸã€‚ã¤ã¾ã‚Šé¶åµçŠ¶æ…‹ ğŸ”ğŸ¥š

1. Argo CD ã® Image ã‚¿ã‚°ã‚’ v3.0 ã«æ›¸ãæ›ãˆã¦ Apply ã™ã‚‹
2. Argo CD (v3.0) ãŒèµ·å‹•ã™ã‚‹
3. Argo CD ãŒè‡ªèº«ã®è¨­å®šï¼ˆSecret åŒ–ã•ã‚ŒãŸ Credential ã‚’å«ã‚€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆï¼‰ã‚’ Git ã‹ã‚‰ Pull ã—ã‚ˆã†ã¨ã™ã‚‹
4. ã“ã“ã§ã‚¨ãƒ©ãƒ¼: v3.0 ã¯ argocd-cm (æ—§è¨­å®š) ã‚’èª­ã¾ãªã„ãŸã‚ã€Git ã¸ã®èªè¨¼æƒ…å ±ãŒãªã„ã¨åˆ¤æ–­ã•ã‚Œã‚‹
5. Git ã‹ã‚‰æ–°ã—ã„è¨­å®šã‚’å–ã£ã¦ã“ã‚Œãªã„ãŸã‚ã€èªè¨¼æƒ…å ±ã‚‚æ›´æ–°ã•ã‚Œãšã€è©°ã‚€ ğŸ”ğŸ¥š

ã“ã®æ™‚ã¯æ‰‹å‹•ã§ sealedsecret ã‚’ apply ã—ãŸä¸Šã§ã€argocd server ã‚’ rollout ã™ã‚‹ã“ã¨ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆv3ç³»ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰ãŒå†é–‹ã—ã€ã“ã¨ãªãã‚’å¾—ã¾ã—ãŸã€‚

### preserveUnknownFields å¯¾å¿œ

Argo CD ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒçµ‚ã‚ã£ãŸã®ã¡ã€ä¸€éƒ¨ãƒªã‚½ãƒ¼ã‚¹ãŒä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã§ degrade ã¨ãªã£ã¦ã„ã¾ã—ãŸã€‚

```
Schema violations found: spec.preserveUnknownFields: Invalid value: true: must be false
```
`spec.preserveUnknownFields` ã¨ã¯ã€CRD ã®è¨­å®šé …ç›®ã®ä¸€ã¤ã§ã€ã‚¹ã‚­ãƒ¼ãƒã«å®šç¾©ã•ã‚Œã¦ã„ãªã„æœªçŸ¥ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã©ã†æ‰±ã†ã‹ã‚’åˆ¶å¾¡ã™ã‚‹ã‚‚ã®ã§ã™

  | å€¤    | å‹•ä½œ                                       |
  |-------|--------------------------------------------|
  | true  | æœªçŸ¥ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãã®ã¾ã¾ä¿æŒï¼ˆå¤ã„å‹•ä½œï¼‰ |
  | false | æœªçŸ¥ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ãƒ»æ‹’å¦ï¼ˆç¾åœ¨ã®æ¨™æº–ï¼‰ |

ä»¥ä¸‹ã® K8s å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹é€šã‚Šã€false ã«è¨­å®šã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#field-pruning
> For compatibility with apiextensions.k8s.io/v1, update your custom resource definitions to:
> 
> Use a structural OpenAPI schema.
> Set spec.preserveUnknownFields to false. â­ï¸

ãã—ã¦ã€

https://argo-cd.readthedocs.io/en/stable/operator-manual/upgrading/2.14-3.0/#removing-default-ignores-of-preserveunknownfields-for-crd

ã“ã“ã§ Argo CD ã¨ã—ã¦ preserveUnknownFields ã‚’ç„¡è¦–ã—ã¦ã„ãŸè¨­å®šå‰Šé™¤ã•ã‚Œã€Schema violations found ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã‚ˆã†ã§ã™ã€‚

ã“ã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã« patch ã‚’ã‚ã¦ã¦å¯¾å¿œã—ã¾ã—ãŸã€‚

```shell
  kubectl get crd -o json | jq -r '.items[] | select(.spec.preserveUnknownFields == true) | .metadata.name' | \
    xargs -I {} kubectl patch crd {} --type=json -p='[{"op": "replace", "path": "/spec/preserveUnknownFields", "value": false}]'
```

### ã“ã®äºŒã¤ã®å¯¾å¿œã‚’è¸ã¾ãˆã¦

é–‹ç™ºç’°å¢ƒã§ã¯ä»Šå›å–ã‚Šä¸Šã’ãŸäºŒã¤ã®å•é¡Œã«ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã‹ã‚‰å¯¾å¿œã—ã¦å¾Œæ‰‹ã«å›ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚ã©ã¡ã‚‰ã‚‚äº‹å‰ã«å¯¾å‡¦ã§ãã‚‹ã®ã§ä»–ã®ç’°å¢ƒã§ã¯ãƒã‚¿ãƒã‚¿ã™ã‚‹ã“ã¨ãªãã‚¹ãƒ ãƒ¼ã‚ºã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã§ãã¾ã—ãŸã€‚ã‚„ã£ãŸã­ âœŒï¸